const express = require('express');
const session = require('express-session');
const flash = require('connect-flash');
const firebaseAdmin = require('firebase-admin');

const app = express();

// 1. Use Expressâ€™s built-in body parsing
app.use(express.urlencoded({ extended: false }));

// 2. Session & Flash
app.use(session({
  secret: 'your_secret_key', // CHANGE THIS for production!
  resave: false,
  saveUninitialized: true,
}));
app.use(flash());

// If behind a proxy (like Heroku), uncomment:
// app.set('trust proxy', 1);

// 3. Firebase Admin initialization
// ----- If using environment variables (preferred) -----
// const serviceAccount = {
//   type: process.env.FIREBASE_TYPE,
//   project_id: process.env.FIREBASE_PROJECT_ID,
//   private_key_id: process.env.FIREBASE_PRIVATE_KEY_ID,
//   private_key: process.env.FIREBASE_PRIVATE_KEY.replace(/\\n/g, '\n'),
//   client_email: process.env.FIREBASE_CLIENT_EMAIL,
//   client_id: process.env.FIREBASE_CLIENT_ID,
//   auth_uri: "https://accounts.google.com/o/oauth2/auth",
//   token_uri: "https://oauth2.googleapis.com/token",
//   auth_provider_x509_cert_url: "https://www.googleapis.com/oauth2/v1/certs",
//   client_x509_cert_url: process.env.FIREBASE_CLIENT_X509_CERT_URL
// };

// ----- Inline approach (make sure formatting is 100% correct!) -----
const serviceAccount = {
  type: "service_account",
  project_id: "partypoints-af474",
  private_key_id: "818f548f697b9b6b69e8629609639bacd09bf3b2",
  private_key: `-----BEGIN PRIVATE KEY-----
MIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQCP1of8BHC78wb5
...etc...
-----END PRIVATE KEY-----`,
  client_email: "firebase-adminsdk-fbsvc@partypoints-af474.iam.gserviceaccount.com",
  client_id: "103712767953127996369",
  auth_uri: "https://accounts.google.com/o/oauth2/auth",
  token_uri: "https://oauth2.googleapis.com/token",
  auth_provider_x509_cert_url: "https://www.googleapis.com/oauth2/v1/certs",
  client_x509_cert_url: "https://www.googleapis.com/robot/v1/metadata/x509/firebase-adminsdk-fbsvc%40partypoints-af474.iam.gserviceaccount.com",
  "universe_domain": "googleapis.com"
};

firebaseAdmin.initializeApp({
  credential: firebaseAdmin.credential.cert(serviceAccount),
  databaseURL: 'https://partypoints-af474-default-rtdb.firebaseio.com'
});

const dbRef = firebaseAdmin.database().ref();

// === Helper Functions ===
function ensureUserExists(username) {
  const userRef = dbRef.child("users").child(username);
  return userRef.once('value').then(snapshot => {
    if (!snapshot.exists()) {
      return userRef.set({
        points: 0,
        transactions: {}
      }).then(() => userRef);
    }
    return userRef;
  });
}

function authenticateUser(username, password) {
  return ensureUserExists(username).then(userRef => {
    return userRef.once('value').then(snapshot => {
      const userData = snapshot.val();
      if (!userData.password) {
        // If no password, set it
        return userRef.update({ password: password }).then(() => {
          return { success: true, message: "New user created and password set." };
        });
      } else {
        if (userData.password === password) {
          return { success: true, message: "Login successful." };
        } else {
          return { success: false, message: "Incorrect password." };
        }
      }
    });
  });
}

// ... addPointsBackend, spendPointsBackend, getBalance, getReport (unchanged) ...

function requireLogin(req, res, next) {
  if (!req.session.username) {
    return res.redirect('/login');
  }
  next();
}

// === Render Helpers ===
function renderHeader(title, username, messages) {
  let nav = '';
  if (username) {
    nav = `<nav>
      <ul>
        <li><a href="/dashboard">Dashboard</a></li>
        <li><a href="/add_points">Add Points</a></li>
        <li><a href="/spend_points">Spend Points</a></li>
        <li><a href="/show_balance">Show Balance</a></li>
        <li><a href="/show_report">Show Report</a></li>
        <li><a href="/logout">Logout</a></li>
      </ul>
    </nav>`;
  }
  let flashHTML = '';
  if (messages.error && messages.error.length > 0) {
    messages.error.forEach(message => {
      flashHTML += `<div class="flash">${message}</div>`;
    });
  }
  if (messages.success && messages.success.length > 0) {
    messages.success.forEach(message => {
      flashHTML += `<div class="flash">${message}</div>`;
    });
  }
  return `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${title}</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f4f4f4; }
    header, footer { background: #333; color: #fff; padding: 1em; text-align: center; }
    nav ul { list-style: none; padding: 0; }
    nav ul li { display: inline; margin: 0 1em; }
    nav ul li a { color: #fff; text-decoration: none; }
    .container { padding: 2em; }
    .flash { background: #ffc; padding: 1em; margin-bottom: 1em; border: 1px solid #dda; }
    form { max-width: 400px; margin: auto; }
    form input, form button { width: 100%; padding: 0.5em; margin: 0.5em 0; }
  </style>
</head>
<body>
<header>
  <h1>PointPartier</h1>
  ${nav}
</header>
<div class="container">
${flashHTML}
`;
}

function renderFooter() {
  return `
</div>
<footer>
  <p>&copy; 2025 PointPartier. All rights reserved.</p>
</footer>
</body>
</html>`;
}

// === Routes ===
app.get('/', (req, res) => {
  if (req.session.username) {
    return res.redirect('/dashboard');
  }
  const headerHTML = renderHeader('Home - PointPartier', null, req.flash());
  const content = `<h2>Welcome to PointPartier</h2>
  <p>Please <a href="/login">login</a> to continue.</p>`;
  res.send(headerHTML + content + renderFooter());
});

// Login (GET)
app.get('/login', (req, res) => {
  const headerHTML = renderHeader('Login - PointPartier', null, req.flash());
  const content = `<h2>Login / Register</h2>
  <form method="POST" action="/login">
    <input type="text" name="username" placeholder="Username" required>
    <input type="password" name="password" placeholder="Password" required>
    <button type="submit">Continue</button>
  </form>`;
  res.send(headerHTML + content + renderFooter());
});

// Login (POST)
app.post('/login', (req, res) => {
  const { username, password } = req.body;
  if (!username || !password) {
    req.flash('error', 'Username and password required.');
    return res.redirect('/login');
  }

  // ADD CATCH BLOCK
  authenticateUser(username, password)
    .then(result => {
      if (result.success) {
        req.session.username = username;
        req.flash('success', result.message);
        res.redirect('/dashboard');
      } else {
        req.flash('error', result.message);
        res.redirect('/login');
      }
    })
    .catch(err => {
      console.error('Login Error:', err);
      req.flash('error', 'An unexpected error occurred, please try again.');
      res.redirect('/login');
    });
});

app.get('/logout', (req, res) => {
  req.session.destroy();
  res.redirect('/');
});

// Dashboard
app.get('/dashboard', requireLogin, (req, res) => {
  getBalance(req.session.username)
    .then(balance => {
      const headerHTML = renderHeader('Dashboard - PointPartier', req.session.username, req.flash());
      const content = `<h2>Dashboard</h2>
        <p>Hello, ${req.session.username}!</p>
        <p>Your current balance is: ${balance}</p>
        <p>Choose an option from the navigation menu above.</p>`;
      res.send(headerHTML + content + renderFooter());
    })
    .catch(err => {
      console.error('Balance Error:', err);
      req.flash('error', 'Failed to load balance.');
      res.redirect('/');
    });
});

// Add Points (GET)
app.get('/add_points', requireLogin, (req, res) => {
  const headerHTML = renderHeader('Add Points - PointPartier', req.session.username, req.flash());
  const content = `<h2>Add Points</h2>
  <form method="POST" action="/add_points">
    <input type="number" name="amount" placeholder="Amount" required>
    <input type="text" name="reason" placeholder="Reason" required>
    <button type="submit">Add Points</button>
  </form>`;
  res.send(headerHTML + content + renderFooter());
});

// Add Points (POST)
app.post('/add_points', requireLogin, (req, res) => {
  const { amount, reason } = req.body;
  addPointsBackend(req.session.username, amount, reason)
    .then(message => {
      req.flash('success', message);
      res.redirect('/dashboard');
    })
    .catch(err => {
      console.error('Add Points Error:', err);
      req.flash('error', 'Failed to add points.');
      res.redirect('/dashboard');
    });
});

// Spend Points (GET)
app.get('/spend_points', requireLogin, (req, res) => {
  const headerHTML = renderHeader('Spend Points - PointPartier', req.session.username, req.flash());
  const content = `<h2>Spend Points</h2>
  <form method="POST" action="/spend_points">
    <input type="number" name="amount" placeholder="Amount" required>
    <input type="text" name="reason" placeholder="Reason" required>
    <button type="submit">Spend Points</button>
  </form>`;
  res.send(headerHTML + content + renderFooter());
});

// Spend Points (POST)
app.post('/spend_points', requireLogin, (req, res) => {
  const { amount, reason } = req.body;
  spendPointsBackend(req.session.username, amount, reason)
    .then(message => {
      req.flash('success', message);
      res.redirect('/dashboard');
    })
    .catch(err => {
      console.error('Spend Points Error:', err);
      req.flash('error', 'Failed to spend points.');
      res.redirect('/dashboard');
    });
});

// Show Balance
app.get('/show_balance', requireLogin, (req, res) => {
  getBalance(req.session.username)
    .then(balance => {
      const headerHTML = renderHeader('Your Balance - PointPartier', req.session.username, req.flash());
      const content = `<h2>Your Balance</h2>
        <p>Your current balance is: ${balance}</p>`;
      res.send(headerHTML + content + renderFooter());
    })
    .catch(err => {
      console.error('Show Balance Error:', err);
      req.flash('error', 'Failed to fetch balance.');
      res.redirect('/dashboard');
    });
});

// Transaction Report
app.get('/show_report', requireLogin, (req, res) => {
  getReport(req.session.username)
    .then(transactions => {
      const headerHTML = renderHeader('Transaction Report - PointPartier', req.session.username, req.flash());
      let content = `<h2>Transaction Report</h2>`;
      if (transactions.length > 0) {
        content += '<ul>';
        transactions.forEach(t => {
          content += `<li>
            <strong>${t.time}</strong> - ${t.type} - Amount: ${t.amount} -
            ${t.description} - Balance After: ${t.balance_after}
          </li>`;
        });
        content += '</ul>';
      } else {
        content += `<p>No transactions found.</p>`;
      }
      res.send(headerHTML + content + renderFooter());
    })
    .catch(err => {
      console.error('Show Report Error:', err);
      req.flash('error', 'Failed to load report.');
      res.redirect('/dashboard');
    });
});

// Start Server
const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`Server started on port ${PORT}`);
});
